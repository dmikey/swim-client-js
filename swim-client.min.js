!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,(n.swim||(n.swim={})).client=e()}}(function(){return function e(n,t,o){function i(s,d){if(!t[s]){if(!n[s]){var a="function"==typeof require&&require;if(!d&&a)return a(s,!0);if(r)return r(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=t[s]={exports:{}};n[s][0].call(l.exports,function(e){var t=n[s][1][e];return i(t?t:e)},l,l.exports,e,n,t,o)}return t[s].exports}for(var r="function"==typeof require&&require,s=0;s<o.length;s++)i(o[s]);return i}({1:[function(e,n,t){n.exports={version:"0.3.0",SEND_BUFFER_SIZE:1024,MAX_RECONNECT_TIME:15e3}},{}],2:[function(e,n,t){},{}],3:[function(e,n,t){n.exports={version:"0.3.0"}},{}],4:[function(e,n,t){"use strict";function o(e){switch(m.tag(e)){case"@event":return u.decode(e);case"@command":return p.decode(e);case"@sync":return f.decode(e);case"@synced":return h.decode(e);case"@link":return v.decode(e);case"@linked":return y.decode(e);case"@unlink":return k.decode(e);case"@unlinked":return g.decode(e)}}function i(e){return e.encode()}function r(e){return o(m.parse(e))}function s(e){return m.stringify(i(e))}function d(){}function a(){d.call(this)}function c(){d.call(this)}function l(){d.call(this)}function u(e,n,t,o){l.call(this),this.node=e,this.lane=n,this.via=t,this.body=o}function p(e,n,t,o){l.call(this),this.node=e,this.lane=n,this.via=t,this.body=o}function f(e,n,t){a.call(this),this.node=e,this.lane=n,this.prio=t||0}function h(e,n){c.call(this),this.node=e,this.lane=n}function v(e,n,t){a.call(this),this.node=e,this.lane=n,this.prio=t||0}function y(e,n,t){c.call(this),this.node=e,this.lane=n,this.prio=t||0}function k(e,n){a.call(this),this.node=e,this.lane=n}function g(e,n){c.call(this),this.node=e,this.lane=n}var b=e("./config.json"),m=e("recon-js");Object.defineProperty(d.prototype,"isRequest",{value:!1}),Object.defineProperty(d.prototype,"isResponse",{value:!1}),Object.defineProperty(d.prototype,"isMessage",{value:!1}),Object.defineProperty(d.prototype,"isEventMessage",{value:!1}),Object.defineProperty(d.prototype,"isCommandMessage",{value:!1}),Object.defineProperty(d.prototype,"isSyncRequest",{value:!1}),Object.defineProperty(d.prototype,"isSyncedResponse",{value:!1}),Object.defineProperty(d.prototype,"isLinkRequest",{value:!1}),Object.defineProperty(d.prototype,"isLinkedResponse",{value:!1}),Object.defineProperty(d.prototype,"isUnlinkRequest",{value:!1}),Object.defineProperty(d.prototype,"isUnlinkedResponse",{value:!1}),a.prototype=Object.create(d.prototype),a.prototype.constructor=a,Object.defineProperty(a.prototype,"isRequest",{value:!0}),c.prototype=Object.create(d.prototype),c.prototype.constructor=c,Object.defineProperty(a.prototype,"isResponse",{value:!0}),l.prototype=Object.create(d.prototype),l.prototype.constructor=l,Object.defineProperty(a.prototype,"isMessage",{value:!0}),u.prototype=Object.create(l.prototype),u.prototype.constructor=u,Object.defineProperty(u.prototype,"isEventMessage",{value:!0}),u.prototype.encode=function(){var e=[{node:this.node},{lane:this.lane}];return this.via&&e.push({via:this.via}),m.concat({"@event":e},this.body)},u.decode=function(e){for(var n,t,o,i=m.tail(e),r=m.head(e),s=r&&r.length||0,d=0;s>d;d+=1){var a=r[d];void 0!==a.node?n=a.node:void 0!==a.lane?t=a.lane:void 0!==a.via?o=a.via:0===d?n=a:1===d?t=a:2===d&&(o=a)}return void 0!==n&&void 0!==t?new u(n,t,o,i):void 0},p.prototype=Object.create(l.prototype),p.prototype.constructor=p,Object.defineProperty(p.prototype,"isCommandMessage",{value:!0}),p.prototype.encode=function(){var e=[{node:this.node},{lane:this.lane}];return this.via&&e.push({via:this.via}),m.concat({"@command":e},this.body)},p.decode=function(e){for(var n,t,o,i=m.tail(e),r=m.head(e),s=r&&r.length||0,d=0;s>d;d+=1){var a=r[d];void 0!==a.node?n=a.node:void 0!==a.lane?t=a.lane:void 0!==a.via?o=a.via:0===d?n=a:1===d?t=a:2===d&&(o=a)}return void 0!==n&&void 0!==t?new p(n,t,o,i):void 0},f.prototype=Object.create(a.prototype),f.prototype.constructor=f,Object.defineProperty(f.prototype,"isSyncRequest",{value:!0}),f.prototype.encode=function(){var e=[{node:this.node},{lane:this.lane}];return this.prio&&e.push({prio:this.prio}),m({"@sync":e})},f.decode=function(e){for(var n,t,o,i=m.head(e),r=i&&i.length||0,s=0;r>s;s+=1){var d=i[s];void 0!==d.node?n=d.node:void 0!==d.lane?t=d.lane:void 0!==d.prio?o=d.prio:0===s?n=d:1===s&&(t=d)}return void 0!==n&&void 0!==t?new f(n,t,o):void 0},h.prototype=Object.create(c.prototype),h.prototype.constructor=h,Object.defineProperty(h.prototype,"isSyncedResponse",{value:!0}),h.prototype.encode=function(){var e=[{node:this.node},{lane:this.lane}];return m({"@synced":e})},h.decode=function(e){for(var n,t,o=m.head(e),i=o&&o.length||0,r=0;i>r;r+=1){var s=o[r];void 0!==s.node?n=s.node:void 0!==s.lane?t=s.lane:0===r?n=s:1===r&&(t=s)}return void 0!==n&&void 0!==t?new h(n,t):void 0},v.prototype=Object.create(a.prototype),v.prototype.constructor=v,Object.defineProperty(v.prototype,"isLinkRequest",{value:!0}),v.prototype.encode=function(){var e=[{node:this.node},{lane:this.lane}];return this.prio&&e.push({prio:this.prio}),m({"@link":e})},v.decode=function(e){for(var n,t,o,i=m.head(e),r=i&&i.length||0,s=0;r>s;s+=1){var d=i[s];void 0!==d.node?n=d.node:void 0!==d.lane?t=d.lane:void 0!==d.prio?o=d.prio:0===s?n=d:1===s&&(t=d)}return void 0!==n&&void 0!==t?new v(n,t,o):void 0},y.prototype=Object.create(c.prototype),y.prototype.constructor=y,Object.defineProperty(y.prototype,"isLinkedResponse",{value:!0}),y.prototype.encode=function(){var e=[{node:this.node},{lane:this.lane}];return this.prio&&e.push({prio:this.prio}),m({"@linked":e})},y.decode=function(e){for(var n,t,o,i=m.head(e),r=i&&i.length||0,s=0;r>s;s+=1){var d=i[s];void 0!==d.node?n=d.node:void 0!==d.lane?t=d.lane:void 0!==d.prio?o=d.prio:0===s?n=d:1===s&&(t=d)}return void 0!==n&&void 0!==t?new y(n,t,o):void 0},k.prototype=Object.create(a.prototype),k.prototype.constructor=k,Object.defineProperty(k.prototype,"isUnlinkRequest",{value:!0}),k.prototype.encode=function(){var e=[{node:this.node},{lane:this.lane}];return m({"@unlink":e})},k.decode=function(e){for(var n,t,o=m.head(e),i=o&&o.length||0,r=0;i>r;r+=1){var s=o[r];void 0!==s.node?n=s.node:void 0!==s.lane?t=s.lane:0===r?n=s:1===r&&(t=s)}return void 0!==n&&void 0!==t?new k(n,t):void 0},g.prototype=Object.create(c.prototype),g.prototype.constructor=g,Object.defineProperty(g.prototype,"isUnlinkedResponse",{value:!0}),g.prototype.encode=function(){var e=[{node:this.node},{lane:this.lane}];return m({"@unlinked":e})},g.decode=function(e){for(var n,t,o=m.head(e),i=o&&o.length||0,r=0;i>r;r+=1){var s=o[r];void 0!==s.node?n=s.node:void 0!==s.lane?t=s.lane:0===r?n=s:1===r&&(t=s)}return void 0!==n&&void 0!==t?new g(n,t):void 0},t.decode=o,t.encode=i,t.parse=r,t.stringify=s,t.Envelope=d,t.RequestEnvelope=a,t.ResponseEnvelope=c,t.MessageEnvelope=l,t.EventMessage=u,t.CommandMessage=p,t.SyncRequest=f,t.SyncedResponse=h,t.LinkRequest=v,t.LinkedResponse=y,t.UnlinkRequest=k,t.UnlinkedResponse=g,t.config=b},{"./config.json":3,"recon-js":"recon-js"}],"swim-client-js":[function(e,n,t){(function(n){"use strict";function o(e,n){l.auth(e,n)}function i(e,n,t){l.get(e).sync(e,n,t)}function r(e,n,t){l.get(e).link(e,n,t)}function s(e,n,t){l.get(e).unlink(e,n,t)}function d(e,n,t){l.get(e).sendEvent(e,n,t)}function a(e,n,t){l.get(e).sendCommand(e,n,t)}function c(){for(var e in l.bridge){var n=l.bridge[e];n.sendBuffer=[],n.unlinkAll(),n.close()}l.bridge={}}function l(e,n){l.bridge[e]=this,this.node=e,this.query=n,this.linkCount=0,this.linkHandles={},this.sendBuffer=[],this.reconnectTimeout=null,this.reconnectTime=250+Math.round(750*Math.random()),this.closed=!1,this.open()}var u=e("./config.json"),p=e("recon-js"),f=e("swim-proto-js"),h=n.WebSocket||e("websocket").w3cwebsocket,v=-2,y=-1,k=0,g=1;l.prototype.open=function(){var e=this.node;this.query&&(e=e+"?"+this.query),this.socket=new h(e),this.socket.onopen=this.onOpen.bind(this),this.socket.onclose=this.onClose.bind(this),this.socket.onmessage=this.onFrame.bind(this),this.socket.onerror=this.onError.bind(this)},l.prototype.close=function(){this.closed=!0,this.socket.close()},l.prototype.send=function(e){this.socket.readyState!==this.socket.OPEN?this.buffer(e):this.socket.send(f.stringify(e))},l.prototype.buffer=function(e){e.isSyncRequest||e.isLinkRequest||e.isUnlinkRequest||this.sendBuffer.length>u.SEND_BUFFER_SIZE||this.sendBuffer.push(e)},l.prototype.onOpen=function(){clearTimeout(this.reconnectTimeout),this.reconnectTime=250+Math.round(750*Math.random());var e;for(var n in this.linkHandles){var t=this.linkHandles[n];for(var o in t){for(var i=t[o],r=!1,s=0,d=i.length;!r&&d>s;s+=1){var a=i[s],c=a.__swim_link_state__;r=r||c.synced}e=r?new f.SyncRequest(this.unresolve(n),o):new f.LinkRequest(this.unresolve(n),o),this.send(e)}}for(;e=this.sendBuffer.shift();)this.send(e)},l.prototype.onClose=function(){if(!this.closed&&0===this.linkCount&&0===this.sendBuffer.length)return void delete l.bridge[this.node];for(var e in this.linkHandles){var n=this.linkHandles[e];for(var t in n)for(var o=n[t],i=0,r=o.length;r>i;i+=1){var s=o[i],d=s.__swim_link_state__;d.status===g&&("function"==typeof s.onBroken&&s.onBroken.call(s,e,t),d.status=y)}}this.closed||(this.reconnectTimeout=setTimeout(this.open.bind(this),this.reconnectTime),this.reconnectTime=Math.min(2*this.reconnectTime,u.MAX_RECONNECT_TIME))},l.prototype.onError=function(){this.socket.readyState===this.socket.OPEN&&this.socket.close()},l.prototype.onFrame=function(e){var n=e.data;if("string"==typeof n){var t=f.parse(n);t&&this.onReceive(t)}},l.prototype.initHandle=function(e,n){"function"==typeof e&&(e={onEvent:e,onCommand:e});var t={status:k,synced:n};return Object.defineProperty(e,"__swim_link_state__",{value:t,configurable:!0}),e},l.prototype.registerHandle=function(e,n,t){var o=!1,i=this.linkHandles[e];void 0===i&&(i={},this.linkHandles[e]=i);var r=i[n];return void 0===r&&(o=!0,r=[],i[n]=r),r.push(t),o},l.prototype.unregisterHandle=function(e,n,t){var o=this.linkHandles[e];if(void 0!==o){var i=o[n];if(void 0!==i){var r=-1;if(t instanceof Function){for(var s=0,d=i.length;d>s;s+=1)if(i[s].onEvent===t){r=s;break}}else r=i.indexOf(t);if(0>r)return!1;i.splice(r,1);var a=0===i.length;return a&&(delete o[n],0===Object.keys(o).length&&delete this.linkHandles[e]),a}}},l.prototype.sync=function(e,n,t){t=this.initHandle(t,!0);var o=this.registerHandle(e,n,t),i=new f.SyncRequest(this.unresolve(e),n);this.send(i),o&&(this.linkCount+=1)},l.prototype.link=function(e,n,t){t=this.initHandle(t,!1);var o=this.registerHandle(e,n,t);if(o){var i=new f.LinkRequest(this.unresolve(e),n);this.send(i),this.linkCount+=1}else if(this.socket.readyState===this.socket.OPEN){var r=t.__swim_link_state__;r.status=g,"function"==typeof t.onLinked&&t.onLinked.call(t,e,n)}},l.prototype.unlink=function(e,n,t){var o=this.unregisterHandle(e,n,t);if(o){var i=new f.UnlinkRequest(this.unresolve(e),n);this.send(i),this.linkCount-=1}},l.prototype.unlinkAll=function(){for(var e in this.linkHandles){var n=this.linkHandles[e];for(var t in n)for(var o=n[t],i=0,r=o.length;r>i;i+=1){var s=o[i],d=s.__swim_link_state__;"function"==typeof s.onFailed&&s.onFailed.call(s,e,t),d.status=v}}this.linkCount=0,this.linkHandles={}},l.prototype.sendEvent=function(e,n,t){var o=new f.EventMessage(this.unresolve(e),n,void 0,t);this.send(o)},l.prototype.sendCommand=function(e,n,t){var o=new f.CommandMessage(this.unresolve(e),n,void 0,t);this.send(o)},l.prototype.onReceive=function(e){e.isEventMessage?this.onMessage(e):e.isCommandMessage?this.onMessage(e):e.isSyncedResponse?this.onSynced(e):e.isLinkedResponse?this.onLinked(e):e.isUnlinkedResponse&&this.onUnlinked(e)},l.prototype.onMessage=function(e){var n=p.uri.stringify(p.uri.resolve(this.node,e.node)),t=this.linkHandles[n];if(void 0!==t)for(var o=e.lane;o;){var i=t[o];if(i)for(var r=0,s=i.length;s>r;r+=1){var d=i[r];e.isEventMessage?"function"==typeof d.onEvent&&d.onEvent.call(d,e):e.isCommandMessage&&"function"==typeof d.onCommand&&d.onCommand.call(d,e)}o=l.parentLane(o)}},l.prototype.onSynced=function(e){var n=p.uri.stringify(p.uri.resolve(this.node,e.node)),t=e.lane,o=this.linkHandles[n];if(void 0!==o){var i=o[t];if(void 0!==i)for(var r=0,s=i.length;s>r;r+=1){var d=i[r];"function"==typeof d.onLinked&&d.onSynced.call(d,n,t)}}},l.prototype.onLinked=function(e){var n=p.uri.stringify(p.uri.resolve(this.node,e.node)),t=e.lane,o=this.linkHandles[n];if(void 0!==o){var i=o[t];if(void 0!==i)for(var r=0,s=i.length;s>r;r+=1){var d=i[r],a=d.__swim_link_state__;a.status===y?"function"==typeof d.onUnbroken&&d.onUnbroken.call(d,n,t):"function"==typeof d.onLinked&&d.onLinked.call(d,n,t),a.status=g}}},l.prototype.onUnlinked=function(e){var n=p.uri.stringify(p.uri.resolve(this.node,e.node)),t=e.lane,o=this.linkHandles[n];if(void 0!==o){var i=o[t];if(void 0!==i){for(var r=0,s=i.length;s>r;r+=1){var d=i[r],a=d.__swim_link_state__;a.status===g?("function"==typeof d.onUnlinked&&d.onUnlinked.call(d,n,t),a.status=k):("function"==typeof d.onFailed&&d.onFailed.call(d,n,t),a.status=v)}delete o[t],0===Object.keys(o).length&&delete this.linkHandles[n],this.linkCount-=1}}},l.prototype.unresolve=function(e){return p.uri.stringify(p.uri.unresolve(this.node,e))},l.bridge={},l.get=function(e){var n=l.endpoint(e),t=l.bridge[n];return void 0===t&&(t=new l(n)),t},l.auth=function(e,n){var t=l.endpoint(e),o=l.bridge[t];return o&&(o.unlinkAll(),o.close(),delete l.bridge[t]),o=new l(t,n)},l.endpoint=function(e){var n=p.uri.parse(e),t=n.scheme;return"swim"===t?t="ws":"swims"===t&&(t="wss"),p.uri.stringify({scheme:t,authority:n.authority})},l.parentLane=function(e){var n=p.uri.parse(e),t=n.path;return n.query&&n.fragment?p.uri.stringify({path:t,query:n.query}):n.query?p.uri.stringify({path:t}):t.length>0?p.uri.stringify({path:t.slice(0,t.length-1)}):void 0},t.auth=o,t.sync=i,t.link=r,t.unlink=s,t.sendEvent=d,t.sendCommand=a,t.reset=c,t.config=u}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./config.json":1,"recon-js":"recon-js","swim-proto-js":4,websocket:2}]},{},[])("swim-client-js")});
//# sourceMappingURL=swim-client.min.js.map
